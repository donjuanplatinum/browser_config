(()=>{const e="custom_options_list",t="spoofer_list",n="use_per_tab",a="permanent_override";const o="c_",i="s_";class r{constructor(e,t,n,a,o,i){this.title=e,this.ua_string=t,this.vendor=n,this.badge=a,this.is_preset=o,this.append_to_default_ua=!1,this.group=i,this.is_managed=!1,this.key=""}}class u{constructor(e,t){this.domain=e,this.user_agent=t,this.is_managed=!1,this.key=""}}function s(){return chrome.storage.local}async function c(){const e=await m();return null!=e?e:(await chrome.storage.local.get(n))[n]}function d(){return chrome.storage.managed.get("EditRights").then((e=>e?.EditRights?.user_agents??null))}function l(){return chrome.storage.managed.get("EditRights").then((e=>e?.EditRights?.permanent_spoofs??null))}function p(){return chrome.storage.managed.get("EditRights").then((e=>e?.EditRights?.other_settings??null))}function _(){return chrome.storage.managed.get("OtherSettings").then((e=>e?.OtherSettings?.spoof_override??null))}function m(){return chrome.storage.managed.get("OtherSettings").then((e=>e?.OtherSettings?.spoof_per_tab??null))}async function f(){return s().get(e).then((({[e]:t})=>t||[]))}function g(e){return s().get(e).then((({[e]:t})=>t))}async function h(){const[e,t]=await Promise.all([w(),f()]);if(!t||0===t.length)return e;const n=await s().get(t);return e.concat(Object.values(n))}function b({title:e,ua_string:t,vendor:n,badge:a,append:o},i){return Object.assign(new r,{is_managed:!0,title:e,ua_string:t,vendor:n,badge:a,append_to_default_ua:o,group:"Managed",key:void 0!==i?"cm_"+i:void 0})}async function w(){return((await chrome.storage.managed.get("UserAgents"))?.UserAgents||[]).map(((e,t)=>b(e,t)))}async function y(e){if(!await d()&&e?.key)return await s().set({[e.key]:e}),e}async function A(t){if(!t||0===t.length)return;if(await d())return;const n=await f();let a=0;if(n&&n.length>0)for(let e=0;e<n.length;e++){const t=parseInt(n[e].substring(o.length));t>=a&&(a=t)}for(let e=0;e<t.length;e++)t[e].key=o+(a+1+e);await s().set({...Object.fromEntries(t.map((e=>[e.key,e]))),[e]:n.concat(t.map((e=>e.key)))})}async function v(t){if(await d())return;const n=(await f()).filter((e=>e!==t));await s().set({[e]:n}),await s().remove(t)}async function x(){return s().get(t).then((({[t]:e})=>e||[]))}async function k(){const e=await async function(){return((await chrome.storage.managed.get("PermanentSpoofs"))?.PermanentSpoofs||[]).map((({domain:e,user_agent:t},n)=>Object.assign(new u,{domain:e,is_managed:!0,key:"sm_"+n,user_agent:b(t,void 0)})))}(),t=await x();if(!t||0===t.length)return e;const n=await s().get(t);return e.concat(Object.values(n))}function E(e){return Math.max(0,...e.map((e=>+e.substring(i.length))))}async function N(e){if(await l())return;const n=(await x()).filter((t=>t!==e));await s().set({[t]:n}),await s().remove(e)}async function M(t,n,a,i,u){const c=new r(t,n,"",i,!1,u);c.append_to_default_ua=a,await async function(t){if(await d())return;const n=await f();if(!t.key||""==t.key){const e=E(n);t.key=o+(e+1)}await s().set({[t.key]:t,[e]:n.concat([t.key])})}(c)}function T(e){return!function(e){return!e||""==e.ua_string}(e)}function S(e){return""==e.ua_string?"[Use default User-agent string]":e.ua_string}function C(e){return""==e.ua_string?"N/A":e.append_to_default_ua?"Append":"Replace"}function I(e){if(!e)return"";const t=[["Chrome","Chrome"],["Firefox","Firefox"],["Opera","Opera"],["Safari","Safari"],["IE","Internet Explorer"],["Internet Explorer","Internet Explorer"],["iPhone","iPhone"],["iPad","iPad"],["iOS","iOS"]];for(let n=0;n<t.length;n++)if(e.toUpperCase().indexOf(t[n][0].toUpperCase())>-1)return t[n][1];return""}function O(e){return e?.group||""}async function W(e){try{const n=JSON.parse(e),a=n.UserAgents;let o={};if(a&&a.length>0){const e=await h();for(let t=0;t<e.length;t++)o[e[t].ua_string]="1";const t=[];for(let e=0;e<a.length;e++)if(a[e].title&&a[e].ua_string&&a[e].badge){const n=new r(a[e].title,a[e].ua_string,a[e].vendor,a[e].badge,!1,a[e].group);n.append_to_default_ua=a[e].append_to_default_ua,n.is_managed=!1,o[n.ua_string]||(o[n.ua_string]="1",t.push(n))}await A(t)}const c=n.PermanentSpoofs;if(o=new Array,c&&c.length>0){const e=await k();for(let t=0;t<e.length;t++)o[e[t].domain+" "+e[t].user_agent.ua_string]="1";const n=[];for(let e=0;e<c.length;e++)if(c[e].domain&&c[e].user_agent&&c[e].user_agent.title&&c[e].user_agent.ua_string&&c[e].user_agent.vendor&&c[e].user_agent.badge){const t=new r(c[e].user_agent.title,c[e].user_agent.ua_string,c[e].user_agent.vendor,c[e].user_agent.badge,!1,c[e].group);t.append_to_default_ua=c[e].user_agent.append_to_default_ua,t.is_managed=!1;const a=new u(c[e].domain,t);a.is_managed=!1,o[a.domain+" "+a.user_agent.ua_string]||(o[a.domain+" "+a.user_agent.ua_string]="1",n.push(a))}await async function(e){if(await l())return;if(!e||0===e.length)return;const n=await x(),a=E(n);e=e.map(((e,t)=>({...e,key:i+(a+1+t)}))),await s().set({...Object.fromEntries(e.map((e=>[e.key,e]))),[t]:n.concat(e.map((e=>e.key)))})}(n)}}catch(e){}}async function P(e){const t=await h();let n=0,a=0;const o={};for(let e=0;e<t.length;e++)o[t[e].ua_string]="1";const i=[];return $("useragent",e).each((function(){const e=new r($(this).attr("description"),$(this).attr("useragent"),"","X",!1,U($(this).parent()));"UA List :: About"!=e.group&&(o[e.ua_string]?a++:n<450&&(o[e.ua_string]="1",i.push(e),n++))})),await A(i),{import_count:n,duplicates:a}}function U(e){const t=$(e)&&$(e).parent().length>0?U($(e).parent()):null,n=$(e).attr("description");return t?t+" - "+n:n||null}async function z(e,n){let a=(await h()).find((e=>e.key===n));a||(a=new r("","","","",!0,"")),await async function(e){if(await l())return!1;if(!e)return!1;const n=await x();if(!e.key){const t=E(n);e.key=i+(t+1)}await s().set({[e.key]:e,[t]:n.concat([e.key])})}(new u(e,a))}function F(){if(""==$("#add_ua_group").val()){let e=I($("#add_ua_user_agent").val());""!=e?$("#add_ua_group").attr("value",e):(e=I($("#add_ua_name").val()),""!=e&&$("#add_ua_group").attr("value",e))}}function R(e){$("#status").text(e)}function K(e,t,n,a){const o=document.createElement("input");return o.setAttribute("class","hidingbox"),o.setAttribute("id",t),o.setAttribute("value",e),o.setAttribute("key",n),o}function L(e,t){return g(e).then((function(e){return e&&(e.title=$("#"+t).attr("value")),y(e)})).then((()=>{R("User-agent edited.")}))}function j(e,t){return g(e).then((function(e){return e&&(e.ua_string=$("#"+t).attr("value")),y(e)})).then((()=>{R("User-agent edited.")}))}function G(e){const t=document.createElement("tr"),n=document.createElement("td");return n.setAttribute("class","ua_title_row"),n.appendChild(document.createTextNode(e)),t.appendChild(n),t}function X(e){const t=document.createElement("tr");for(let n=0;n<e.length;n++){if(!e[n])continue;const a=document.createElement("td");a.appendChild(e[n]),t.appendChild(a)}return t}async function D(e){const t=await k();for(const n of t)n.domain===e&&(await N(n.key),await B());R("Spooflist entry deleted.")}function B(){return k().then((function(e){let t=$("#list_table");return t.replaceWith(document.createElement("table")),t=$("#tablecontainer table"),t.prop("id","list_table"),t.append(function(){const e=X([document.createTextNode("Domain"),document.createTextNode("User-Agent String"),document.createTextNode(""),document.createTextNode("")]);return e.setAttribute("class","title"),e}()),l().then((function(n){n||(t.append(function(){const e=document.createElement("input"),t=document.createTextNode(""),n=document.createElement("input");e.setAttribute("id","add_ua"),e.setAttribute("type","hidden"),n.setAttribute("id","add_domain");const a=document.createElement("input");a.type="button",a.setAttribute("id","add_entry_button"),a.value="Add";const o=document.createElement("span");return o.appendChild(e),o.appendChild(function(){const e=document.createElement("select");e.setAttribute("id","options");const t=document.createElement("option");return t.setAttribute("value",""),t.appendChild(document.createTextNode("[Default]")),e.appendChild(t),e}()),X([n,o,t,a])}()),$("#add_entry_button").on("click",(function(){""==$("#add_domain").val()?(R("All fields are required."),$("#add_domain").toggleClass("error",!0),$("#add_ua").toggleClass("error",!0)):z(document.getElementById("add_domain").value,$("#options").val()).then((function(){B(),R("Blacklist entry added."),$("#add_domain").attr("value",""),$("#add_ua").attr("value","")}))})),$("#options").on("change",(function(){$("#add_ua").attr("value",$("#options option:selected").val())})));for(let a=0;a<e.length;a++){const o=e[a],i=document.createElement("div"),r=$("<div id='spoof_"+o.key+"'>"+o.domain+"</div>");$(r).on("hover",(function(e){$(r).toggleClass("invisible")}),(function(e){$(r).toggleClass("invisible")}));const u=X([document.createTextNode(o.domain),document.createTextNode(o.user_agent&&o.user_agent.ua_string?o.user_agent.ua_string:"[Default]"),document.createTextNode(""),null,i]);t.append(u),!e[a]||e[a].is_managed||n||(i.setAttribute("alt","delete"),i.setAttribute("id","delete_"+a),i.setAttribute("border","0"),i.setAttribute("class","deletebutton"),$("#delete_"+a).on("click",function(e){return function(){D(e)}}(o.domain)))}d().then((function(e){t=$("#ua_add_table"),t.empty();let n=function(){const e=X([document.createTextNode("New User-agent name"),document.createTextNode("New User-Agent String"),document.createTextNode("Group"),document.createTextNode("Append?"),document.createTextNode("Indicator Flag"),document.createTextNode("")]);return e.setAttribute("class","title"),e}();n.setAttribute("class","ua_list_sub_table"),t.append(n),e||(n=function(){const e=document.createElement("input"),t=document.createElement("input"),n=document.createElement("select"),a=document.createElement("input"),o=document.createElement("input");e.setAttribute("id","add_ua_name"),t.setAttribute("id","add_ua_indicator"),a.setAttribute("id","add_ua_user_agent"),t.setAttribute("maxlength","3"),t.setAttribute("size","3"),n.setAttribute("id","add_ua_is_append"),o.setAttribute("id","add_ua_group");const i=document.createElement("option");i.setAttribute("value","false"),i.appendChild(document.createTextNode("Replace")),n.appendChild(i);const r=document.createElement("option");r.setAttribute("value","true"),r.appendChild(document.createTextNode("Append")),n.appendChild(r);const u=document.createElement("input");return u.type="button",u.setAttribute("id","add_ua_button"),u.value="Add",X([e,a,o,n,t,u])}(),n.setAttribute("class","ua_list_sub_table"),t.append(n),$("#add_ua_button").on("click",(function(){""==$("#add_ua_name").val()||""==$("#add_ua_user_agent").val()||""==$("#add_ua_indicator").val()?(R("All fields are required."),$("#add_ua_name").toggleClass("error",!0),$("#add_ua_user_agent").toggleClass("error",!0),$("#add_ua_indicator").toggleClass("error",!0)):M($("#add_ua_name").val(),$("#add_ua_user_agent").val(),"true"==$("#add_ua_is_append").val(),$("#add_ua_indicator").val(),$("#add_ua_group").val()).then(B)})),$("#add_ua_user_agent").on("change",(function(){F()})),$("#add_ua_name").on("change",(function(){F()}))),function(e){(async function(){const e=await h();return Object.fromEntries(Map.groupBy(e,O))})().then((function(t){const n=$("#ua_list_table");n.empty();let a=0;for(let o in t){a+=1,n.append(G(""==o?"[No group]":o));const i=t[o],r=document.createElement("table"),u=document.createElement("tr"),s=document.createElement("td");s.appendChild(r),u.appendChild(s),n.append(u),r.setAttribute("id","ua_list_sub_table_"+o),r.setAttribute("class","ua_list_sub_table");for(let t=0;t<i.length;t++){const n=document.createElement("div");e||i[t].is_managed||!T(i[t])?r.appendChild(X([document.createTextNode(i[t].title),document.createTextNode(S(i[t])),document.createTextNode(C(i[t])),document.createTextNode(i[t].badge),T(i[t])?n:document.createTextNode("")])):(r.appendChild(X([K(i[t].title,"text_ua_title_"+i[t].key,i[t].key),K(S(i[t]),"text_ua_string_"+i[t].key,i[t].key),document.createTextNode(C(i[t])),document.createTextNode(i[t].badge),T(i[t])?n:document.createTextNode("")])),$("#text_ua_title_"+i[t].key).on("blur",function(e,t){return function(){L(e,t)}}(i[t].key,"text_ua_title_"+i[t].key)),$("#text_ua_string_"+i[t].key).on("blur",function(e,t){return function(){j(e,t)}}(i[t].key,"text_ua_string_"+i[t].key))),i[t].is_managed||e||(n.setAttribute("class","deletebutton"),n.setAttribute("border","0"),n.setAttribute("alt","delete"),n.setAttribute("id","delete_preset_"+a+"_"+t),$("#delete_preset_"+a+"_"+t).on("click",function(e,t){return function(){(async function(e){const t=await h();for(let n=0;n<t.length;n++)if(t[n].title==e){await v(t[n].key);break}})(e).then(B)}}(i[t].title,i[t].is_preset)))}}}))}(e),h().then((function(e){const t=$("#options");if(t){t.children().remove();for(let n=0;n<e.length;n++)if(""!=e[n].ua_string){const a=document.createElement("option");a.setAttribute("value",e[n].key),a.appendChild(document.createTextNode(e[n].title)),t.append(a)}}})),c().then((e=>{m().then((t=>{$("#spoof_per_tab").prop("checked",e),$("#spoof_per_tab").prop("disabled",null!=t)}))})),async function(){const e=await _();return null!=e?e:!!(await s().get(a))[a]}().then((e=>{_().then((t=>{$("#permanent_override").prop("checked",e),$("#permanent_override").prop("disabled",null!=t)}))})),$("#local_file_import").on("change",J),async function(){return await h(),await k(),JSON.stringify({UserAgents:await h(),PermanentSpoofs:await k()})}().then((function(e){$("#export_button").prop("href","data:text/csv;charset=utf-8,"+encodeURIComponent(e))}))}))}))}))}function H(e,t){$(".menu_controlled").addClass("invisible"),e.removeClass("invisible"),$(".menuitem").removeClass("selected"),t.addClass("selected")}function J(e){const t=e.target.files;for(let e,n=0;e=t[n];n++){const t=new FileReader;t.onload=function(e){return function(t){return e.name.endsWith("json")?W(t.target.result).then((function(){$("#import_result").empty(),$("#import_result").append(document.createTextNode("JSON configuration file loaded.")),R("JSON file import complete."),B()})):e.name.endsWith("xml")?P(t.target.result).then((function(e){$("#import_result").empty(),0==e.import_count&&0==e.duplicates?$("#import_result").append("No user-agent strings found.  Please be sure this is the correct XML format mentioned above."):$("#import_result").append(document.createTextNode("Result: "+e.import_count+" imported successfully, "+e.duplicates+" duplicates removed.")),B()})):($("#import_result").empty(),$("#import_result").append("The file provided does not end in '.xml' or '.json'.  Please rename the file and try again."),void R("Did not import."))}}(e),t.readAsText(e)}}chrome.declarativeNetRequest.MAX_NUMBER_OF_SESSION_RULES,$(window).on("load",(function(){B(),$("#menu_ua").on("click",(function(){B(),H($("#custom_ua_table"),$(this))})),$("#menu_spoof").on("click",(function(){B(),H($("#permanent_spoof_table"),$(this))})),$("#menu_other").on("click",(function(){H($("#other_settings_table"),$(this))})),$("#menu_about").on("click",(function(){H($("#about_table"),$(this))})),p().then((function(e){e?($("#menu_import").hide(),$("#menu_other").hide()):($("#menu_import").show(),$("#menu_other").show())})),$("#menu_import").on("click",(function(){H($("#import_table"),$(this))})),$("#permanent_override").on("change",(function(){!async function(){const e=$("#permanent_override").prop("checked");await async function(e){null==await _()&&await s().set({[a]:e})}(e),R(e?"Permanent spoofs now always override fast-switch.":"Permanent spoofs now do not override the fast-switch.")}()})),$("#resetter").on("click",(function(){!async function(){await d()||(await async function(){await p()||await s().set({[t]:[],[e]:[]})}(),await async function(t){const n=new Array;n.push(new r("Default","","","",!0,"Chrome")),n.push(new r("Windows Firefox 33","Mozilla/5.0 (Windows NT 6.1; WOW64; rv:33.0) Gecko/20120101 Firefox/33.0","Mozilla, Inc.","FFW",!0,"Firefox")),n.push(new r("Mac Firefox 33","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10; rv:33.0) Gecko/20100101 Firefox/33.0","Mozilla, Inc.","FFM",!0,"Firefox")),n.push(new r("Opera 12.14","Opera/9.80 (Windows NT 6.0) Presto/2.12.388 Version/12.14","Mozilla, Inc.","O12",!0,"Opera")),n.push(new r("Mac Safari 7","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.75.14 (KHTML, like Gecko) Version/7.0.3 Safari/7046A194A","Apple, Inc.","S7",!0,"Safari")),n.push(new r("Internet Explorer 6","Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; WOW64; Trident/4.0; SLCC1)","Microsoft","IE6",!0,"Internet Explorer")),n.push(new r("Internet Explorer 7","Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; WOW64; Trident/4.0; SLCC1)","Microsoft","IE7",!0,"Internet Explorer")),n.push(new r("Internet Explorer 8","Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; WOW64; Trident/4.0; SLCC1)","Microsoft","IE8",!0,"Internet Explorer")),n.push(new r("Internet Explorer 9","Mozilla/5.0 (MSIE 9.0; Windows NT 6.1; Trident/5.0)","Microsoft","IE9",!0,"Internet Explorer")),n.push(new r("Internet Explorer 10","Mozilla/5.0 (MSIE 10.0; Windows NT 6.1; Trident/5.0)","Microsoft","IE10",!0,"Internet Explorer")),n.push(new r("iPhone 6","Mozilla/5.0 (iPhone; CPU iPhone OS 6_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10A5376e Safari/8536.25","Apple, Inc.","IP6",!0,"iOS")),n.push(new r("iPad","Mozilla/5.0 (iPad; CPU OS 6_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10A5376e Safari/8536.25","Apple, Inc.","iPad",!0,"iOS")),n.push(new r("Android KitKat","Mozilla/5.0 (Linux; Android 4.4.2; Nexus 4 Build/KOT49H) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.114 Mobile Safari/537.36","","AND",!0,"Android")),n.push(new r("Windows Phone 8","Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920)","","WP7",!0,"Windows Phone"));{const t=await h(),a=[];for(let e=0;e<t.length;e++)a.push(t[e].key);a&&a.length>0&&await s().remove([...a,e]),await A(n)}return n}(),await B(),H($(".menu_controlled:first"),$(".menuitem:first")))}()})),$("#spoof_per_tab").on("change",(function(){!async function(){const e=$("#spoof_per_tab").prop("checked");await async function(e){null==await m()&&(await async function(){await chrome.storage.session.remove("hotlist")}(),await chrome.storage.local.set({[n]:e}))}(e),R(e?"Spoofs set in the menu bar will now only affect the current tab.":"Spoofs set in the menu bar will now affect all tabs.")}()})),H($(".menu_controlled:first"),$(".menuitem:first"))}))})();